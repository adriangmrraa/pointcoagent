<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pointe Coach Platform | AI Control Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body class="dark-theme">
    <div class="glass-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <span class="logo-icon">ü©∞</span>
                <span class="logo-text">POINTE COACH</span>
            </div>
            <nav>
                <button class="nav-item active" onclick="showView('overview')">
                    <span class="icon">üìä</span> Panel General
                </button>
                <button class="nav-item" onclick="startSetupWizard()">
                    <span class="icon">‚öôÔ∏è</span> Configuraci√≥n
                </button>
                <button class="nav-item" onclick="showView('stores')">
                    <span class="icon">üèòÔ∏è</span> Mis Tiendas
                </button>
                <button class="nav-item" onclick="showView('chats')">
                    <span class="icon">üí¨</span> Conversaciones
                </button>
                <button class="nav-item" onclick="showView('logs')">
                    <span class="icon">üìú</span> Live History
                </button>
                <button class="nav-item" onclick="showView('analytics')">
                    <span class="icon">üìà</span> M√©tricas Avanzadas
                </button>
                <!-- New items -->
                <button class="nav-item" onclick="showView('credentials')">
                    <span class="icon">üîê</span> Credenciales
                </button>
                <button class="nav-item" onclick="showView('ycloud')">
                    <span class="icon">üì±</span> WhatsApp (YCloud)
                </button>
                <button class="nav-item" onclick="showView('whatsapp-meta')">
                    <span class="icon">üí¨</span> WhatsApp Meta API
                </button>
                <button class="nav-item" onclick="showView('tools')">
                    <span class="icon">üîß</span> Herramientas
                </button>
                <button class="nav-item" onclick="showView('console')">
                    <span class="icon">üíª</span> Consola
                </button>
            </nav>
            <div class="sidebar-footer">
                <div class="status-badge" id="system-status">Sistema Online</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <header class="top-bar">
                <div class="mobile-collapsible collapsed" id="health-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('health-collapsible')">
                        Estado del Sistema
                    </div>
                    <div class="collapsible-content">
                        <div class="health-strip">
                            <div class="service-pill ok" id="orchestrator-status">
                                <div class="pill-dot"></div>
                                Orchestrator
                            </div>
                            <div class="service-pill ok" id="whatsapp-status">
                                <div class="pill-dot"></div>
                                WhatsApp
                            </div>
                            <div class="service-pill ok" id="tiendanube-status">
                                <div class="pill-dot"></div>
                                Tienda Nube
                            </div>
                            <div class="service-pill ok" id="database-status">
                                <div class="pill-dot"></div>
                                Database
                            </div>
                            <div class="service-pill ok" id="redis-status">
                                <div class="pill-dot"></div>
                                Redis
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mobile-collapsible collapsed" id="signals-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('signals-collapsible')">
                        Se√±ales Recientes
                    </div>
                    <div class="collapsible-content">
                        <div class="last-signals">
                            <div class="signal-item">
                                <div>
                                    <div class="signal-label">√öltima Entrada</div>
                                    <div class="signal-value" id="last-inbound">Cargando...</div>
                                </div>
                            </div>
                            <div class="signal-item">
                                <div>
                                    <div class="signal-label">√öltima Salida</div>
                                    <div class="signal-value" id="last-outbound">Cargando...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="top-actions">
                    <button class="btn-secondary" onclick="openModal('diagnostics-modal')">Run Diagnostics</button>
                    <button class="btn-primary" onclick="startSetupWizard()">Open Setup</button>
                    <div class="version-badge" id="version-badge">v1.0.0</div>
                </div>
            </header>

            <!-- Views -->
            <section id="view-overview" class="view">
                <h1 class="view-title">Dashboard Master</h1>
                <div class="stats-grid">
                    <div class="stat-card glass">
                        <span class="stat-label">Tiendas Activas</span>
                        <span class="stat-value" id="stat-active-tenants">0</span>
                        <div class="stat-meta">+1 esta semana</div>
                    </div>
                    <div class="stat-card glass accent">
                        <span class="stat-label">Mensajes Totales</span>
                        <span class="stat-value" id="stat-total-messages">0</span>
                        <div class="stat-meta">Interacciones totales</div>
                    </div>
                    <div class="stat-card glass">
                        <span class="stat-label">√âxito IA</span>
                        <span class="stat-value" id="stat-success-rate">0%</span>
                        <div class="stat-meta">Status: √ìptimo</div>
                    </div>
                </div>

                <div class="activity-row">
                    <div class="activity-card glass">
                        <h3>√öltima Actividad</h3>
                        <div id="last-activity">
                            <div class="activity-item">
                                <span class="activity-time" id="last-inbound-time">Nunca</span>
                                <span class="activity-desc">√öltimo mensaje recibido</span>
                            </div>
                            <div class="activity-item">
                                <span class="activity-time" id="last-outbound-time">Nunca</span>
                                <span class="activity-desc">√öltimo mensaje enviado</span>
                            </div>
                        </div>
                    </div>
                    <div class="alerts-card glass">
                        <h3>Estado del Sistema</h3>
                        <div id="system-alerts">
                            <div class="alert-item info">Sistema operativo</div>
                            <div class="alert-item success" id="tenants-status">Cargando tenants...</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-stores" class="view">
                <div class="view-header">
                    <h1 class="view-title">Gesti√≥n de Tiendas</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-secondary" onclick="deleteAllTenants()"
                            style="background: #f44336; color: white;">üóëÔ∏è Eliminar Todas</button>
                        <button class="btn-primary" onclick="resetTenantModal(); openModal('tenant-modal')">+ Nueva
                            Tienda</button>
                    </div>
                </div>
                <div class="stores-table-container glass">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tienda</th>
                                <th>WhatsApp</th>
                                <th>Tienda Nube ID</th>
                                <th>Status</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tenants-list">
                            <!-- JS populated -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- New view: Chats (Human-in-the-Loop) -->
            <section id="view-chats" class="view">
                <div class="chats-layout">
                    <!-- Left Column: Chat List -->
                    <div class="chat-list-container glass">
                        <div class="chat-list-header">
                            <input type="text" id="chat-search" placeholder="Buscar..." onkeyup="filterChats()">
                            <button onclick="loadChats()" class="btn-icon">üîÑ</button>
                        </div>
                        <div class="chat-list" id="chat-list-items">
                            <!-- Populated by JS -->
                            <div class="chat-loading">Cargando conversaciones...</div>
                        </div>
                    </div>

                    <!-- Right Column: Chat Window -->
                    <div class="chat-window-container glass">
                        <div id="chat-empty-state" class="chat-empty-state">
                            <div class="empty-icon">üí¨</div>
                            <h3>Selecciona una conversaci√≥n</h3>
                            <p>Aqu√≠ ver√°s el historial y podr√°s intervenir manualmente.</p>
                        </div>

                        <div id="chat-interface" style="display: none;">
                            <div class="chat-header">
                                <button class="btn-back" onclick="backToChatList()" style="display: none;">‚Üê</button>
                                <div class="chat-avatar">üë§</div>
                                <div class="chat-info">
                                    <h3 id="chat-current-phone">Loading...</h3>
                                    <span class="chat-role-badge">WhatsApp User</span>
                                </div>
                                <div class="chat-controls"
                                    style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                                    <label class="switch-toggle"
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <span id="human-override-label"
                                            style="font-size: 13px; color: var(--text-secondary);">Agente Activo</span>
                                        <div class="toggle-wrapper"
                                            style="position: relative; width: 44px; height: 24px;">
                                            <input type="checkbox" id="human-override-toggle"
                                                onchange="toggleHumanOverride()">
                                            <span class="slider round"></span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="chat-messages" id="chat-messages-area">
                                <!-- Messages -->
                            </div>

                            <div class="chat-input-area">
                                <textarea id="chat-input-text"
                                    placeholder="Escribe un mensaje manual (Human Override)..."></textarea>
                                <button onclick="sendManualMessage()" id="chat-send-btn" class="btn-primary">‚û§</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-logs" class="view">
                <h1 class="view-title">Historia Viva de Mensajes</h1>
                <div class="logs-container glass">
                    <div class="logs-feed" id="logs-list">
                        <!-- JS populated -->
                    </div>
                </div>
            </section>

            <!-- New view: Credenciales -->
            <section id="view-credentials" class="view">
                <div class="view-header">
                    <h1 class="view-title">Gesti√≥n de Credenciales</h1>
                    <div class="credentials-controls" style="display: flex; gap: 10px; align-items: center;">
                        <select id="cred-filter-tenant" onchange="loadCredentials()"
                            style="padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--text-primary);">
                            <option value="">Todos los Tenants</option>
                        </select>
                        <select id="cred-filter-type" onchange="loadCredentials()"
                            style="padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--text-primary);">
                            <option value="">Todos los Tipos</option>
                            <option value="OpenAI">OpenAI</option>
                            <option value="WhatsApp API">WhatsApp API</option>
                            <option value="YCloud">YCloud</option>
                            <option value="Tienda Nube">Tienda Nube</option>
                            <option value="Redis">Redis</option>
                            <option value="Postgres">Postgres</option>
                            <option value="Other">Otro</option>
                        </select>
                        <button class="btn-primary" onclick="resetCredentialModal(); openModal('cred-modal')">+ Nueva
                            Credencial</button>
                    </div>
                </div>
                <div class="creds-table-container glass">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Valor</th>
                                    <th>Tipo</th>
                                    <th>Tenant</th>
                                    <th>√Åmbito</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="creds-list">
                                <!-- JS populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- New view: WhatsApp (YCloud) -->
            <section id="view-ycloud" class="view">
                <div class="view-header">
                    <h1 class="view-title">Configuraci√≥n de WhatsApp (YCloud)</h1>
                    <button class="btn-primary" onclick="openModal('ycloud-config-modal')">Configurar YCloud</button>
                </div>
                <div class="ycloud-info glass">
                    <p>En esta secci√≥n puedes agregar la API Key y el Webhook Secret de YCloud. Despu√©s de guardar,
                        reinicia el servicio de WhatsApp para que los cambios surtan efecto.</p>
                </div>
            </section>

            <!-- New view: WhatsApp Meta API -->
            <section id="view-whatsapp-meta" class="view">
                <div class="view-header">
                    <h1 class="view-title">Configuraci√≥n de WhatsApp Meta API</h1>
                    <button class="btn-primary" onclick="openModal('whatsapp-meta-modal')">Configurar Meta API</button>
                </div>
                <div class="whatsapp-meta-info glass">
                    <h3>Gu√≠a de Configuraci√≥n - WhatsApp Business API</h3>
                    <div class="setup-steps">
                        <div class="step">
                            <div class="service-icon">1</div>
                            <h4>Crear App en Meta for Developers</h4>
                            <p>Ve a <a href="https://developers.facebook.com" target="_blank">Meta for Developers</a> y
                                crea una nueva app de tipo "Business".</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 1</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">2</div>
                            <h4>Agregar WhatsApp Product</h4>
                            <p>En tu app, ve a "Add Product" y selecciona "WhatsApp". Esto te dar√° acceso a la Business
                                API.</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 2</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">3</div>
                            <h4>Configurar Webhook</h4>
                            <p>En WhatsApp ‚Üí Settings, configura la URL del webhook y el verify token. La URL debe ser
                                accesible p√∫blicamente.</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 3</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">4</div>
                            <h4>Obtener Access Token</h4>
                            <p>Genera un access token permanente desde WhatsApp ‚Üí Settings ‚Üí API. Este token no expira.
                            </p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 4</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">5</div>
                            <h4>Verificar N√∫mero de Tel√©fono</h4>
                            <p>Asocia y verifica el n√∫mero de tel√©fono que usar√°s como bot. Meta enviar√° un c√≥digo de
                                verificaci√≥n.</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 5</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">6</div>
                            <h4>Configurar Plantilla de Mensajes</h4>
                            <p>Crea plantillas de mensajes aprobadas por Meta para iniciar conversaciones con clientes.
                            </p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 6</span>
                            </div>
                        </div>
                        <div class="step">
                            <div class="service-icon">7</div>
                            <h4>Probar Conexi√≥n</h4>
                            <p>Una vez configurado todo, guarda las credenciales arriba y prueba la conexi√≥n.</p>
                            <div class="service-status">
                                <span class="status-dot configured"></span>
                                <span class="status-text">Paso 7</span>
                            </div>
                        </div>
                    </div>

                    <div class="step-actions">
                        <button class="btn-secondary" onclick="copyWebhookUrl()">Copiar URL del Webhook</button>
                        <button class="btn-primary" onclick="testWhatsAppMetaConnection()">Probar Conexi√≥n Meta
                            API</button>
                    </div>

                    <div id="meta-test-result" class="test-result-container"></div>

                    <div class="warning-note">
                        <strong>‚ö†Ô∏è Importante:</strong> La Meta WhatsApp API requiere aprobaci√≥n de Meta y tiene costos
                        asociados. Aseg√∫rate de cumplir con las pol√≠ticas de WhatsApp Business.
                    </div>
                </div>
            </section>

            <!-- New view: Analytics -->
            <section id="view-analytics" class="view">
                <div class="view-header">
                    <h1 class="view-title">M√©tricas Avanzadas</h1>
                    <div class="analytics-controls">
                        <select id="analytics-tenant-filter" onchange="loadAnalytics()">
                            <option value="">Todas las tiendas</option>
                        </select>
                        <select id="analytics-time-filter" onchange="loadAnalytics()">
                            <option value="7">√öltimos 7 d√≠as</option>
                            <option value="30">√öltimos 30 d√≠as</option>
                            <option value="90">√öltimos 90 d√≠as</option>
                        </select>
                        <button class="btn-secondary" onclick="loadAnalytics()">üîÑ Actualizar</button>
                    </div>
                </div>

                <!-- KPIs Summary -->
                <div class="analytics-kpis glass">
                    <h3>Indicadores Clave de Rendimiento</h3>
                    <div class="kpis-grid" id="analytics-kpis">
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-conversations">0</div>
                            <div class="kpi-label">Conversaciones</div>
                            <div class="kpi-meta">Total de chats iniciados</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-messages">0</div>
                            <div class="kpi-label">Mensajes</div>
                            <div class="kpi-meta">Total de mensajes</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-success-rate">0%</div>
                            <div class="kpi-label">Tasa de √âxito</div>
                            <div class="kpi-meta">Mensajes procesados</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpi-avg-response">0ms</div>
                            <div class="kpi-label">Tiempo Respuesta</div>
                            <div class="kpi-meta">Promedio IA</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Container -->
                <div class="analytics-charts">
                    <div class="chart-container glass">
                        <h3>Conversaciones por D√≠a</h3>
                        <div class="chart-placeholder" id="conversations-chart">
                            <div class="chart-empty">
                                <div class="empty-icon">üìä</div>
                                <p>No hay datos de conversaciones disponibles</p>
                                <small>Los datos aparecer√°n aqu√≠ cuando haya actividad en el sistema</small>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container glass">
                        <h3>Intent Distribution</h3>
                        <div class="chart-placeholder" id="intent-chart">
                            <div class="chart-empty">
                                <div class="empty-icon">üéØ</div>
                                <p>No hay datos de intents disponibles</p>
                                <small>Los datos aparecer√°n aqu√≠ cuando la IA detecte intents</small>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container glass">
                        <h3>Top Error Codes</h3>
                        <div class="chart-placeholder" id="errors-chart">
                            <div class="chart-empty">
                                <div class="empty-icon">‚ö†Ô∏è</div>
                                <p>No hay errores registrados</p>
                                <small>¬°Excelente! El sistema est√° funcionando sin errores</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Tables -->
                <div class="analytics-tables">
                    <div class="table-section glass">
                        <h3>Eventos Recientes</h3>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha/Hora</th>
                                        <th>Evento</th>
                                        <th>Severidad</th>
                                        <th>Descripci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="analytics-events">
                                    <tr>
                                        <td colspan="4" class="empty-row">
                                            <div class="table-empty">
                                                <div class="empty-icon">üìã</div>
                                                <p>No hay eventos recientes</p>
                                                <small>Los eventos del sistema aparecer√°n aqu√≠</small>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- New view: Herramientas -->
            <section id="view-tools" class="view">
                <div class="view-header">
                    <h1 class="view-title">Gesti√≥n de Herramientas</h1>
                    <button class="btn-primary" onclick="openModal('tool-modal')">+ Nueva Herramienta</button>
                </div>
                <div class="tools-table-container glass">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>URL Servicio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tools-list">
                            <!-- JS populated -->
                        </tbody>
                    </table>
                </div>

                <!-- Human Handoff Configuration -->
                <div class="handoff-config-section glass" style="margin-top: 30px; padding: 30px;">
                    <div class="section-header"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div>
                            <h2 style="color: var(--accent); margin-bottom: 5px;">ü§ù Derivaci√≥n a Humano (derivhumano)
                            </h2>
                            <p style="color: var(--text-secondary); font-size: 14px;">Define cu√°ndo la IA debe ceder el
                                control al equipo humano y c√≥mo debe notificar.</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="handoff-enabled" onchange="toggleHandoffUI()">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div id="handoff-form-container"
                        style="opacity: 0.5; pointer-events: none; transition: var(--transition);">
                        <!-- Granular Policy Rules -->
                        <div class="policy-grid"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                            <div class="policy-box glass" style="padding: 20px;">
                                <h3 style="font-size: 15px; margin-bottom: 15px; color: var(--accent);">üéØ ¬øCu√°ndo
                                    Derivar? (Policy)</h3>
                                <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 10px;">
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-fitting"> Solicitud de Fitting / Asesora / Turno
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-reclamo"> Reclamos o tono negativo
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-dolor"> Dolor / Lesi√≥n / Incomodidad
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-talle"> Ambig√ºedad de talle no resuelta
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="rule-especial"> Coordinaci√≥n especial / Retiros
                                    </label>
                                </div>
                            </div>
                            <div class="policy-box glass" style="padding: 20px;">
                                <h3 style="font-size: 15px; margin-bottom: 15px; color: var(--accent-secondary);">‚úâÔ∏è
                                    ¬øQu√© incluir en el Email?</h3>
                                <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 10px;">
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="ctx-name" checked> Nombre del usuario
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="ctx-phone" checked> Tel√©fono / WhatsApp ID
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="ctx-history"> Resumen de √∫ltimos mensajes
                                    </label>
                                    <label class="checkbox-container">
                                        <input type="checkbox" id="ctx-id"> Conversation ID & Timestamp
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group full">
                                <label>Instrucciones Adicionales (AI Instructions)</label>
                                <textarea id="handoff-instructions" rows="3"
                                    placeholder="Instrucciones espec√≠ficas adicionales para el agente..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Email de Destino (Recepci√≥n)</label>
                                <input type="email" id="handoff-target-email" placeholder="ejemplo@correo.com">
                            </div>
                            <div class="form-group">
                                <label>Mensaje al Cliente (Feedback)</label>
                                <input type="text" id="handoff-message"
                                    placeholder="Te derivo con una persona del equipo...">
                            </div>
                        </div>

                        <!-- SMTP Config Box -->
                        <div class="smtp-config-box glass"
                            style="margin-top: 30px; padding: 25px; border: 1px solid rgba(255,255,255,0.05);">
                            <h3 style="font-size: 15px; margin-bottom: 20px; color: var(--accent);">‚öôÔ∏è Configuraci√≥n
                                SMTP (Admin)</h3>
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>Host SMTP</label>
                                    <input type="text" id="smtp-host" placeholder="smtp.ejemplo.com">
                                </div>
                                <div class="form-group">
                                    <label>Puerto SMTP</label>
                                    <input type="number" id="smtp-port" placeholder="465">
                                </div>
                                <div class="form-group">
                                    <label>Seguridad (Security)</label>
                                    <select id="smtp-security">
                                        <option value="SSL">SSL (Recom. 465)</option>
                                        <option value="STARTTLS">STARTTLS (Recom. 587)</option>
                                        <option value="NONE">NONE</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Usuario SMTP</label>
                                    <input type="text" id="smtp-user" placeholder="usuario@ejemplo.com">
                                </div>
                                <div class="form-group">
                                    <label>Contrase√±a SMTP</label>
                                    <input type="password" id="smtp-pass" placeholder="********">
                                    <small style="color: var(--text-secondary); font-size: 11px;">Escribe para
                                        cambiarla, deja ******** para mantener.</small>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 30px; text-align: right;">
                            <select id="handoff-tenant-select"
                                style="background: var(--bg-card); color: white; border: 1px solid var(--border-glass); border-radius: 8px; padding: 8px;">
                                <option value="">Seleccionar Tenant...</option>
                            </select>
                            <button class="btn btn-primary" onclick="saveHandoffSettings()">
                                <span>üíæ Guardar Configuraci√≥n de Derivaci√≥n</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- New view: Consola -->
            <section id="view-console" class="view">
                <div class="view-header">
                    <h1 class="view-title">Consola del Sistema</h1>
                    <div class="console-controls">
                        <button class="btn-secondary" onclick="clearConsole()">üóëÔ∏è Limpiar</button>
                        <button class="btn-secondary" onclick="toggleAutoScroll()">üìú Auto-scroll</button>
                        <button class="btn-primary" onclick="startConsoleStreaming()">‚ñ∂Ô∏è Iniciar Streaming</button>
                        <button class="btn-secondary" onclick="stopConsoleStreaming()">‚è∏Ô∏è Detener</button>
                    </div>
                </div>
                <div class="console-filters glass">
                    <div class="filter-group">
                        <label>Filtro por Severidad:</label>
                        <select id="severity-filter" onchange="applyConsoleFilters()">
                            <option value="">Todas</option>
                            <option value="debug">Debug</option>
                            <option value="info">Info</option>
                            <option value="warn">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Filtro por Tipo:</label>
                        <input type="text" id="type-filter" placeholder="Ej: message.incoming"
                            onkeyup="applyConsoleFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Buscar:</label>
                        <input type="text" id="search-filter" placeholder="Buscar en eventos..."
                            onkeyup="applyConsoleFilters()">
                    </div>
                </div>
                <div class="console-container glass">
                    <div class="console-output" id="console-output">
                        <!-- Real-time events will appear here -->
                        <div class="console-welcome">
                            <div class="welcome-icon">üíª</div>
                            <h3>Consola del Sistema CodExy</h3>
                            <p>Haz clic en "Iniciar Streaming" para ver eventos en tiempo real del sistema.</p>
                            <div class="console-tips">
                                <strong>Tips de Debug:</strong>
                                <ul>
                                    <li>üì± <strong>WhatsApp:</strong> Eventos de mensajes entrantes/salientes</li>
                                    <li>ü§ñ <strong>IA:</strong> Procesamiento de respuestas del agente</li>
                                    <li>üõ†Ô∏è <strong>Herramientas:</strong> Llamadas a APIs externas</li>
                                    <li>‚ö†Ô∏è <strong>Errores:</strong> Problemas y excepciones</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Welcome / Connect View -->
            <section id="view-welcome" class="view active">
                <div class="welcome-container">
                    <h1 class="view-title">Bienvenido a CodExy</h1>
                    <p class="welcome-description">Verifica la conexi√≥n y configura tu bot de WhatsApp para Tienda Nube.
                    </p>

                    <div class="welcome-cards">
                        <!-- Card 1: Conectar API -->
                        <div class="welcome-card glass">
                            <div class="card-icon">üîó</div>
                            <h3>Conectar API</h3>
                            <p>Verifica la conexi√≥n con el orquestador</p>
                            <div class="card-status" id="api-status">Pendiente</div>
                            <button class="btn-primary" onclick="connectInstance()">Conectar</button>
                        </div>

                        <!-- Card 2: Webhook URL -->
                        <div class="welcome-card glass">
                            <div class="card-icon">üì°</div>
                            <h3>Webhook URL</h3>
                            <p>URL para configurar en YCloud</p>
                            <div class="webhook-display">
                                <code id="webhook-url-display">Cargando...</code>
                                <button class="btn-secondary" onclick="copyWebhookUrl()">Copiar</button>
                            </div>
                            <button class="btn-secondary" onclick="verifyWebhook()">Verificar Entrada</button>
                        </div>

                        <!-- Card 3: Checklist -->
                        <div class="welcome-card glass">
                            <div class="card-icon">‚úÖ</div>
                            <h3>Estado de Configuraci√≥n</h3>
                            <div class="checklist">
                                <div class="check-item" id="check-tenant">
                                    <span class="check-status">‚ùå</span> Tienda configurada
                                </div>
                                <div class="check-item" id="check-tiendanube">
                                    <span class="check-status">‚ùå</span> Tienda Nube conectada
                                </div>
                                <div class="check-item" id="check-openai">
                                    <span class="check-status">‚ùå</span> OpenAI configurado
                                </div>
                                <div class="check-item" id="check-ycloud">
                                    <span class="check-status">‚≠ï</span> WhatsApp YCloud ok
                                </div>
                                <div class="check-item" id="check-meta">
                                    <span class="check-status">‚≠ï</span> WhatsApp Meta API ok
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="welcome-actions">
                        <button class="btn-primary" onclick="startSetupWizard()">Comenzar Configuraci√≥n</button>
                    </div>
                </div>
            </section>

            <!-- Setup Wizard View - Session-Based for Self-Hosted -->
            <section id="view-setup" class="view">
                <div class="setup-container">
                    <h1 class="view-title">Asistente de Despliegue - CodExy</h1>
                    <p class="welcome-description">Verificaremos tu infraestructura antes de configurar WhatsApp y Meta.
                        Esto garantiza que todo funcione correctamente en tu entorno self-hosted.</p>

                    <!-- Dynamic content loaded by JavaScript -->
                    <div id="setup-content">
                        <div class="setup-loading">
                            <div class="progress-spinner"></div>
                            <h3>Iniciando verificaci√≥n...</h3>
                            <p>Preparando el asistente de despliegue</p>
                        </div>
                    </div>

                    <div class="setup-info">
                        <div class="info-card glass">
                            <h4>üîç ¬øQu√© verifica este asistente?</h4>
                            <ul>
                                <li>‚úÖ Configuraci√≥n de dominio p√∫blico y TLS</li>
                                <li>‚úÖ Conectividad de webhooks y APIs</li>
                                <li>‚úÖ Base de datos y persistencia</li>
                                <li>‚úÖ Reloj del servidor (NTP)</li>
                                <li>‚úÖ Credenciales requeridas</li>
                                <li>‚úÖ Reverse proxy y puertos</li>
                            </ul>
                        </div>

                        <div class="info-card glass">
                            <h4>üéØ ¬øPor qu√© es importante?</h4>
                            <p>En despliegues self-hosted, los problemas m√°s comunes son de infraestructura, no de
                                c√≥digo. Este asistente previene configuraciones rotas y reduce tickets de soporte.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Sidebar Toggle Button (Mobile) -->
    <div class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()"></div>

    <!-- Modals -->
    <div id="tenant-modal" class="modal-overlay">
        <div class="modal glass">
            <h2 id="tenant-modal-title">Configuraci√≥n de Tienda</h2>
            <form id="tenant-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre de la Tienda</label>
                        <input type="text" name="store_name" required>
                    </div>
                    <div class="form-group">
                        <label>N√∫mero de WhatsApp Bot</label>
                        <input type="text" name="bot_phone_number" required placeholder="5411...">
                    </div>
                    <div class="form-group">
                        <label>Email del Propietario</label>
                        <input type="email" name="owner_email" placeholder="email@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label>Ubicaci√≥n de la Tienda</label>
                        <input type="text" name="store_location" placeholder="Ciudad, Pa√≠s">
                    </div>
                    <div class="form-group">
                        <label>Sitio Web</label>
                        <input type="url" name="store_website" placeholder="https://tu-tienda.com">
                    </div>
                    <div class="form-group">
                        <label>Tienda Nube</label>
                        <select name="tiendanube_store_preset" id="tn-store-preset" onchange="updateTNFields()">
                            <option value="">Seleccionar tienda existente...</option>
                            <option value="custom">Configurar manualmente</option>
                        </select>
                    </div>
                    <div id="tn-manual-fields" style="display: none;">
                        <div class="form-group">
                            <label>Tienda Nube ID</label>
                            <input type="text" name="tiendanube_store_id">
                        </div>
                        <div class="form-group">
                            <label>Tienda Nube Token</label>
                            <input type="password" name="tiendanube_access_token">
                        </div>
                    </div>
                    <div class="form-group full">
                        <label>Descripci√≥n / Branding (IA Context)</label>
                        <textarea name="store_description" rows="3"></textarea>
                    </div>
                    <div class="form-group full">
                        <label>Conocimiento de Cat√°logo</label>
                        <textarea name="store_catalog_knowledge" rows="5"
                            placeholder="Listado de categor√≠as, marcas, etc..."></textarea>
                    </div>
                </div>

                <!-- Credentials Section in Tenant Modal -->
                <div class="tenant-credentials-section"
                    style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h3>Credenciales Asociadas</h3>
                    <div id="tenant-credentials-list" class="credentials-list-compact">
                        <!-- Populated by JS -->
                        <div style="text-align: center; color: #aaa; padding: 10px;">Cargando credenciales...</div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('tenant-modal')">Cancelar</button>
                    <button type="button" id="delete-tenant-btn" class="btn-delete" onclick="deleteTenant()"
                        style="display: none;">üóëÔ∏è Eliminar</button>
                    <button type="submit" class="btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Credentials -->
    <div id="cred-modal" class="modal-overlay" onclick="handleModalClick(event, 'cred-modal')">
        <div class="modal glass">
            <h2>Agregar/Editar Credencial</h2>
            <form id="cred-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" name="name" required placeholder="e.g., OPENAI_API_KEY">
                    </div>
                    <div class="form-group">
                        <label>Valor</label>
                        <input type="password" name="value" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo (Categor√≠a)</label>
                        <select name="category" required>
                            <option value="OpenAI">OpenAI</option>
                            <option value="WhatsApp API">WhatsApp API</option>
                            <option value="YCloud">YCloud</option>
                            <option value="Tienda Nube">Tienda Nube</option>
                            <option value="Redis">Redis</option>
                            <option value="Postgres">Postgres</option>
                            <option value="Other">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>√Åmbito</label>
                        <select name="scope" required onchange="toggleTenantSelector()">
                            <option value="global">Global</option>
                            <option value="tenant">Tenant</option>
                        </select>
                    </div>
                    <div class="form-group" id="tenant-selector" style="display: none;">
                        <label>Tenant</label>
                        <select name="tenant_id" id="cred-tenant-select">
                            <option value="">Seleccionar tenant...</option>
                        </select>
                    </div>
                    <div class="form-group full">
                        <label>Descripci√≥n (opcional)</label>
                        <textarea name="description" rows="2"
                            placeholder="Describe el prop√≥sito de esta credencial..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('cred-modal'); resetCredentialModal();">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for YCloud Config -->
    <div id="ycloud-config-modal" class="modal-overlay">
        <div class="modal glass">
            <h2>Configurar YCloud</h2>
            <form id="ycloud-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" name="api_key" required>
                    </div>
                    <div class="form-group">
                        <label>Webhook Secret</label>
                        <input type="password" name="webhook_secret" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tenant</label>
                    <select name="tenant_id" id="ycloud-tenant-select" required>
                        <option value="">Seleccionar tenant...</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('ycloud-config-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for WhatsApp Meta API Config -->
    <div id="whatsapp-meta-modal" class="modal-overlay">
        <div class="modal glass">
            <h2>Configurar WhatsApp Meta API</h2>
            <form id="whatsapp-meta-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Access Token</label>
                        <input type="password" name="access_token" required placeholder="EAA...">
                    </div>
                    <div class="form-group">
                        <label>Phone Number ID</label>
                        <input type="text" name="phone_number_id" required placeholder="123456789">
                    </div>
                    <div class="form-group">
                        <label>Business Account ID</label>
                        <input type="text" name="business_account_id" required placeholder="123456789">
                    </div>
                    <div class="form-group">
                        <label>Verify Token</label>
                        <input type="password" name="verify_token" required placeholder="tu_verify_token">
                    </div>
                </div>
                <div class="form-group">
                    <label>Tenant</label>
                    <select name="tenant_id" id="whatsapp-meta-tenant-select" required>
                        <option value="">Seleccionar tenant...</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('whatsapp-meta-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Tools -->
    <div id="tool-modal" class="modal-overlay">
        <div class="modal glass">
            <h2>Crear Nueva Herramienta</h2>
            <form id="tool-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <select name="type" required onchange="updateToolConfig()">
                            <option value="http">HTTP</option>
                            <option value="tienda_nube">Tienda Nube</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>URL del Servicio</label>
                        <input type="text" name="service_url" placeholder="http://service:8000">
                    </div>
                </div>
                <div id="tool-config" class="form-grid">
                    <!-- Dynamic config fields -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('tool-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Crear Herramienta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Tenant Details -->
    <div id="tenant-detail-modal" class="modal-overlay">
        <div class="modal glass" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="tenant-detail-title">Detalles del Tenant</h2>
                <button class="btn-close" onclick="closeModal('tenant-detail-modal')">√ó</button>
            </div>

            <div id="tenant-detail-content">
                <!-- Tenant Info -->
                <div class="tenant-info-section glass">
                    <h3>Informaci√≥n del Tenant</h3>
                    <div class="tenant-info-grid">
                        <div class="info-item">
                            <label>Nombre de Tienda:</label>
                            <span id="detail-store-name">-</span>
                        </div>
                        <div class="info-item">
                            <label>N√∫mero WhatsApp:</label>
                            <span id="detail-phone-number">-</span>
                        </div>
                        <div class="info-item">
                            <label>Email:</label>
                            <span id="detail-owner-email">-</span>
                        </div>
                        <div class="info-item">
                            <label>Tienda Nube ID:</label>
                            <span id="detail-tn-store-id">-</span>
                        </div>
                        <div class="info-item">
                            <label>Ubicaci√≥n:</label>
                            <span id="detail-location">-</span>
                        </div>
                        <div class="info-item">
                            <label>Sitio Web:</label>
                            <span id="detail-website">-</span>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Status -->
                <div class="whatsapp-status-section glass">
                    <h3>Estado de WhatsApp</h3>
                    <div class="status-blocks">
                        <div class="status-block" id="ycloud-status-block">
                            <div class="status-icon">üì±</div>
                            <div class="status-info">
                                <h4>YCloud</h4>
                                <div class="status-indicator" id="ycloud-indicator">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Verificando...</span>
                                </div>
                                <div class="status-details" id="ycloud-details"></div>
                            </div>
                        </div>

                        <div class="status-block" id="meta-status-block">
                            <div class="status-icon">üí¨</div>
                            <div class="status-info">
                                <h4>Meta API</h4>
                                <div class="status-indicator" id="meta-indicator">
                                    <span class="status-dot"></span>
                                    <span class="status-text">Verificando...</span>
                                </div>
                                <div class="status-details" id="meta-details"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Credentials -->
                <div class="credentials-section glass">
                    <h3>Credenciales</h3>
                    <div class="credentials-tabs">
                        <button class="tab-btn active" onclick="showCredentialTab('tenant')">Tenant-Specific</button>
                        <button class="tab-btn" onclick="showCredentialTab('global')">Global</button>
                    </div>
                    <div id="tenant-credentials-list" class="credentials-list">
                        <!-- Tenant credentials will be populated here -->
                    </div>
                    <div id="global-credentials-list" class="credentials-list" style="display: none;">
                        <!-- Global credentials will be populated here -->
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('tenant-detail-modal')">Cerrar</button>
                <button class="btn-primary" onclick="editTenantFromDetail()">Editar Tenant</button>
            </div>
        </div>
    </div>

    <!-- Diagnostics Modal -->
    <div id="diagnostics-modal" class="modal-overlay" style="display: none;">
        <div class="modal glass">
            <h2>Diagn√≥stico del Sistema</h2>
            <div id="diagnostics-content">
                <p>Verificando servicios...</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('diagnostics-modal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Tour Overlay -->
    <div id="tour-overlay" class="tour-overlay" style="display: none;">
        <div class="tour-card">
            <div id="tour-icon">üìä</div>
            <h2 id="tour-title">Bienvenido a CodExy</h2>
            <div id="tour-content">Comenzaremos un tour guiado para que conozcas todas las funcionalidades de la
                plataforma.</div>
            <div class="tour-buttons">
                <button id="tour-skip" class="tour-skip">Omitir Tour</button>
                <button id="tour-next" class="tour-next">Comenzar</button>
            </div>
        </div>
    </div>

    <!-- Service Selection Modal -->
    <div id="service-selection-modal" class="modal-overlay" style="display: none;">
        <div class="modal glass">
            <h2>Configurar Servicios</h2>
            <p class="modal-description">Selecciona qu√© servicios deseas configurar. Los servicios ya configurados
                aparecen en verde.</p>
            <div class="service-cards-grid">
                <div class="service-card" id="tn-service-card" onclick="selectService('tiendanube')">
                    <div class="service-icon">üè™</div>
                    <h3>Tienda Nube</h3>
                    <p>Conecta tu tienda online para acceder a productos y pedidos</p>
                    <div class="service-status" id="tn-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Verificando...</span>
                    </div>
                </div>
                <div class="service-card" id="ycloud-service-card" onclick="selectService('ycloud')">
                    <div class="service-icon">üì±</div>
                    <h3>WhatsApp (YCloud)</h3>
                    <p>Configura WhatsApp Business con YCloud para mensajer√≠a</p>
                    <div class="service-status" id="ycloud-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Verificando...</span>
                    </div>
                </div>
                <div class="service-card" id="meta-service-card" onclick="selectService('whatsapp-meta')">
                    <div class="service-icon">üí¨</div>
                    <h3>WhatsApp Meta API</h3>
                    <p>Usa la API oficial de WhatsApp Business de Meta</p>
                    <div class="service-status" id="meta-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Verificando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('service-selection-modal')">Omitir y
                    Continuar</button>
                <button class="btn-primary" onclick="goToOverview()">Ir al Dashboard</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="modal-overlay" style="display: none;">
        <div class="modal glass" style="text-align: center;">
            <div id="notification-icon" style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
            <h2 id="notification-title">√âxito</h2>
            <p id="notification-message">Operaci√≥n completada correctamente.</p>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn-primary" onclick="closeModal('notification-modal')">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Runtime Config -->
    <script src="env.js"></script>
    <script src="app.js"></script>
</body>

</html>